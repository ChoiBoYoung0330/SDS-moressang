[moressang]

## App 개발 기획의도 및 목적
다양한 건강관리 서비스를 통해 건강 상태에 맞는 생활 습관 추천 등 건강관리 서비스를 활성화시키고자 함과 더불어 운동, 여양제 등 전 세계적인 건강관리의 수요가 증가하고 있다. 반면에 건강의 가장 기본이 되는 필수 영양소 섭취 중 수분 섭취는 건강에 미치는 영향에 비해 그 중요성이 간과되고 있다. 2013년부터 2017년까지의 국민건강영양조사 자료를 분석한 결과, 우리 국민의 하루 평균 수분 섭취량은 2167ml로, 전체의 62%가 나이대의 수분 섭취 기준을 충족하지 못한다고 한다. 체내 수분이 부족해지면 탈수를 비롯해 결석, 비만, 당뇨병 등 다양한 질환의 원인이 될 수 있다.

70여 년 전 미국 연구에서 나온 하루에 몸에서 빠져나가는 수분이 2L 이상이어서 최소 2L는 마셔야 한다는 말이 회자가 되어 ‘하루 2L 물 마시기’가 퍼져 나갔다. 하지만 물을 필요 이상으로 마시게 되면 신체가 너무 많은 물을 함유하게 되어 우리 몸에 필요한 나트륨을 묽게 하면서 '저나트륨혈증'상태에 빠질 수 있다. 평균적인 활동량을 조사한 결과 하루 2L가 소모된다는 기존 연구 결과는 물이 아닌 '수분'을 뜻하며 순수한 물 이외에도 음식과 같은 다양한 경로로의 섭취도 포함된다.

따라서 수분 섭취가 제공하는 뇌 기능 향상, 다이어트 효과 증대, 심혈관 질환 예방 등의 효과를 누리며, 한 번에 많은 양의 수분 섭취가 아닌 자주 틈틈이 수분을 섭취할 수 있는 올바른 수분 섭취 습관을 형성할 수 있도록 하기 위해 프로젝트를 진행하였다.

## 유사 App 서비스
[WaterMinder]
Waterminder는 2019년 앱스토어 올해의 앱으로 선정된 개인의 수분 섭취량 및 시점을 기록 할 수 있는 서비스이다. 사용자는 스마트폰/스마트워치를 통해 수분 섭취량을 기록할 수 있고 수분 섭취 독려를 위해 주기적으로 알림을 받는다.

하지만 App을 사용해보며 개선해야될 점과 불편한 점을 보자면,
1. 사용자가 눈대중으로 측정한 부정확한 수분 섭취 기록
2. 초기 데이터로 계산된 목표 섭취량에 도달하기 어려움
3. 한국에서 섭취하는 음료와 상이
4. 사용자에게 유용한 정보로 가공되지 않고 축적만 되는 데이터
5. 누적 섭취량 데이터는 제공하지만, 섭취관련 분석을 제공하지 않음
6. 실제 사용자 수분 섭취에 기반한 알림이 아닌 30분마다 스팸성 알림 제공

## 최종 목표
[App]
1. 정확한 수분 섭취 기록을 위한 기능
2. 스팸성 알림이 아닌 수분 섭취 패턴을 통해 도출된 시간에 알림을 제공하여 수분 섭취 독려
3. 한국에서 섭취하는 음료의 종류 추가

[사용자]
1. 단순 목표 섭취량에 도달하는 것이 아닌 규칙적이고 정기적인 수분 섭취 독려를 위해 수분 섭취 패턴을 기반으로 일일 수분 섭취량을 제안
2. 건강과 직결된 음주 섭취 행태를 객관적으로 기록하여 개인 데이터를 의료기관에 제공할 수 있는 기틀을 마련하여 의료기관과 사용자 간의 긴밀한 연계를 돕고자 함


## 주요 기능
<img width="425" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/23698cf9-cf5e-4afc-a4fb-a0ab071e4cc0">

1. 온보딩
   - 구글 로그인
   - 사용자 기본 정보 수집 : 성별/활동량/몸무게 수집
2. 홈화면
   - 수분섭취기록
     - 직접입력
     - 음료 검색하여 입력
   - 수분섭취 내역
     - 오늘 누적 섭취량 조회
     - 오늘 목표 섭취량 조회
     - 오늘 예상 섭취량 조회
     - 수분 섭취 예상시간 조회
3. 섭취로그
   - 일별 섭취내역 조회
4. 섭취 분석
   - 일일 섭취 추세 그래프
   - 5일간 섭취 내역 및 목표 달성 여부 막대 그래프
   - 전체 기록 중 음료별 섭취 비중 원형 그래프
5. 설정
   - 사용자 기본 정보 수정
   - 로그아웃

## 개발 내용
<img width="384" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/cb719489-ea97-40af-a12e-6aef57678404">

1. state 관리
   - 사용자별로 서비스에 별도로 데이터를 저장해야함
   - 사용자는 개별 로그인을 진행하고, 인증 데이터를 앱 내에 저장해야함
   - flutter의 바닐라 state 관리는 main.dart에서 context를 통해 공유가 가능하지만, 그 기능이 제한적이고 코드의 가독성을 해쳤음
   - 또한 다른 위젯을 실행하면 현재 실행중인 위젯의 state가 모두 초기화 되어 API 호출이 잦아짐
   - flutter 전역 state를 관리하는 provider 도입을 통해 보다 더 간편하게 state 관리가 가능해짐
   - 로그인 상태를 전역 State로 관리하여 화면 전환 후에도 지속해서 로그인 상태를 유지할 수 있음
   - 자주 사용되는 사용자의 데이터를 전역 state로 관리하여 API의 잦은 호출을 방지함
   - watch등의 기능을 통해 하나의 API 메서드 호출 시 같은 state를 공유하는 다른 화면을 동시에 업데이트 할 수 있음
2. FireStore 구조
   - 데이터는 firebase의 FireStore를 통해 저장함
   - 유저데이터 저장 구조
     <img width="284" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/42063128-e57f-4d83-85c9-51abcbdb8ee3">
   - 음료 데이터 저장 구조
     <img width="284" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/f0cac58d-c5ca-44c7-ba0e-c0edf9316bb2">

     - 각 회사별 컬렉션을 별도로 구성하여, 데이터별로 랜덤 id를 부여함(초기 음료 데이터를 모두 저장하였으나, 사용중 너무 많은 read가 발생하여 firebase 기본 사용량을 초과하여 일부 샘플 데이터만 포함함)
3. main.dart
   - firebase 연동
   - provider 선언
   - 유저 로그인 유무 확인
   - 로그인 되어 있지 않을 때 login.dart
   - 로그인 되어 있을 시 homeMain.dart
   - 유저 기본 정보 유무 확인
   - 없을 시 setUser.dart
   - 있을 시 homeMain.dart
4. /screen/*.dart
   - 각 메뉴의 실질적인 화면을 담당하는 코드
   - 개발의 용이성을 위해 모두 Stateful Widget으로 구성하였음
   - provider의 전역 state를 지속적으로 listen한다
5. /api/*.dart
   - firebase의 firestore에서 필요한 데이터를 받아오는 코드를 포함한다.
   - 기본 api의 CURD를 담당하는 부분이다
   - 시간 상 한계로 일부 데이터에 한해 수정 및 삭제를 구현하지 못하였지만, 사용자에게 전달하는 기능에 있어 큰 문제는 존재하지 않음
6. provider.dart
   - ml, api의 리턴값을 받아와 전역 State로 변경하는 코드이다
   - 음료 데이터의 WaterState 클래스와 유저데이터의 UserState로 구분된다
   - api의 메소드를 호출하고, provider의 전역 State로 설정한다
   - notifyListeners()를 통해 스크린에서 state를 참조하고 있는 변수를 업데이트 한다
7. ml.dart
   - tflite_flutter를 활용해서 개발 완료한 .tflite 모델을 불러온다
   - 입력 데이터를 기반으로 추론을 진행하고, 결과값을 리턴한다
8. notification.dart
   - flutter_local_notifications를 활용해 시스템 내 알림을 제공하는 코드를 포함한다
   - showNotification() 메서드에 알림 제목, 알림 내용을 인자로 제공하면 시스템 내 알림이 표출된다

## ML 모델 개발
[수분섭취량 예측모델]
-	지수평활법과 lstm을 이용한 모델. 이전의 데이터들을 활용해서 다음날 사용자가 마시게 될 양을 예측하고 제공해줌. 사용자에게 구체적인 수치로 예측한 하루 수분섭취량을 제공함으로써 정기적인 수분 섭취를 독려
-	전처리 코드
  - 사용자의 기존 데이터를 csv 형태로 받아옴
  - 기존 데이터들 중에서 ‘Date’와 ‘Day Total(ml)’를 제외한 나머지 column은 사용하지 않으므로 drop
  - 시계열데이터이므로 내림차순으로 정렬된 ‘Date’를 올림차순으로 정렬
  - ‘Date’는 날짜 type으로, ‘Day Total(ml)은 float type으로 형변환
-	모델 구성
  - Exponential Smoothing method를 사용
  - 예측 할 값의 이전 데이터들인 ‘Day Total(ml)’을 적용
  - trend는 추세변동으로, ‘Day Total(ml)’column은 증가 혹은 감소하므로 ‘add’적용
  - seasonal은 계절변동으로, 단위기간 내에서 반복적이고 알려진 주기가 있을 경우 사용하지만 test data에는 seasonality가 없으므로 ‘None’적용
  - ‘Day Total(ml)’column의 첫번째 행부터 마지막 행까지 predict 모델에 적용
-	TensorFlow 모델을 만들기 위한 코드
  - 1차원 입력을 받아 10개의 노드를 가진 relu 활성화 함수를 사용하는 밀집 레이어와 1개의 노드를 가진 밀집 레이어로 구성
  - 실제 사용자의 ‘Day Total(ml)’을 입력 데이터로 받아 출력 데이터를 생성
-	시계열 데이터를 n_split 개의 폴드로 분할
  - 각 폴드는 연속된 시간 기간을 뜻하며 train 및 검증 데이터로 사용
  - TimeSeriesSplit을 활용하여 시계열적인 특성을 그대로 살려 분할 (n_splits=3)
-	모델 컴파일 : optimizer: ‘adam’, loss: ‘mse’
-	모델 변환 : 완성된 모델은 tf.lite.TFLiteConverter.from_keras_model()을 사용하여 변환하였음

[수분섭취시간 예측모델]
-	CNN을 이용한 모델. 사용자의 수분섭취 여부를 1시간 단위로 확인 후, 변환된 데이터를 활용하여 다음날의 수분 섭취 시간대를 예측함. 이것을 통해 규칙적인 수분 섭취를 독려
-	전처리 코드
  - 사용자의 기존 데이터를 csv 형태로 받아옴
  - 기존 데이터들이 역순으로 정렬되어있어, ‘Date’를 기준으로 내림차순하고 그 안에서 ‘Time’을 기준으로 이중정렬
  - 사용자의 수분섭취 시점을 편리하게 예측하기 위해 ‘Date’와 ‘Time’열을 1시간 단위로 반올림 하여 사용하고, 이것을 ‘Hour’열로 재설정
  - ‘Date’, ‘Time’, ‘Hour’를 사용하여 데이터들을 1시간단위로 쪼개고, 각 시간대에 대한 횟수를 표기함. 만들어진 리스트를 2차원 형태의 리스트로 모든 날에 대하여 (337,24) 형태로 not_null_daily_new_variable로 저장
  - 만들어진 리스트에서 마셨는지 여부만 체크하기 위해 0인경우는 그대로 0, 0이 아닌 경우는 전부 1로 바꾼 후 그대로 not_null_daily_new_variable로 저장
  - 변경 전: [2,0,1,0,0,0,0,0,0,1,1,0,3,0,1,0,0,0,0,1,0,0,0,0] 
  - 변경 후: [1,0,1,0,0,0,0,0,0,1,1,0,1,0,1,0,0,0,0,1,0,0,0,0]
  - 해당 값들을 데이터 학습에 적합하도록 np. array로 변환
  - 기존 LSTM으로 학습시켰지만 tflite의 변환 과정에 문제가 지속적으로 발생하여 문제가 발생하지 않도록 비교적 간단한 CNN 구조를 활용하여 예측
-	모델구성
  - 입력층: Conv1D를 사용하여 1차원 컨볼루션 층을 생성, 활성화 함수로 ReLU를 사용함. 입력 데이터의 shape는 (input_data.shape[1],1)로 설정
  - 풀링층: GlobalMaxPooling1D를 사용하여 컨볼루션 층의 출력에서 가장 큰 값을 추출
  - 출력층: Dense를 사용하여 출력층을 생성하고, 추후 예측의 사용성을 위해 정의역을 0~1로 가진 활성화 함수로 Sigmoid를 활용
-	모델 컴파일 : optimizer: ‘adam’, loss: ‘mse’
-	데이터셋 분할 : TimeSeriesSplit을 활용하여 시계열적인 특성을 그대로 살려 분할 (n_splits=5)
-	Early Stopping 콜백 : 검증 손실이 10번 이상 개선되지 않을 경우, 학습을 조기종료
-	모델 변환 : 완성된 모델은 tf.lite.TFLiteConverter.from_keras_model()을 사용하여 변환
-	모델 평가 : 예측값은 아래와 같은 실수형태로 나오므로 마셨는지, 마시지 않았는지에 대한 binary적인 평가가 되지 않으므로 적합한 평가지표가 아님
  - [0.20907344 0.16560748 0.10260876 0.05081807 0.04700811 0.03259553 0.04637376 0.05002645 0.05139894 0.08005121 0.1291611 0.21319048 0.23382588 0.31278887 0.31144848 0.26406685 0.27012154 0.3294935 0.34728754 0.3039891 0.26110095 0.3087529 0.33785984 0.5508183 ]
  - 평가를 위해 다음날 실제 물을 마신 총 횟수만큼 상위값을 선택 후, 모델 값을 조정하여 데이터에 대해 평균적으로 가장 많이 맞춘 모델을 선택하였음. 평가 방법에 대한 예시는 다음과 같음
  - 위의 실수형 predictions를 높은 순서대로 정렬 후, 해당 값의 인덱스를 받아옴
  - 다음 날의 실제 일어난 시간대의 횟수를 확인하고 해당 횟수만큼 상위값을 선택
    - 전날 이벤트 값: [0 0 0 0 0 0 0 0 0 1 0 1 1 0 1 0 1 0 0 0 0 1 0 1] 
    - 다음 이벤트 값: [0 0 0 0 0 0 0 0 0 0 0 1 1 1 0 0 0 0 0 0 0 1 1 1] 
    - 예측 이벤트 값: [0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 1 0 1 0 1 1] 
  - 실제 값과의 차이: 4회 
  - 결과 해석: 12,21시에는 먹었지만 알림을 주지 않았고 18,20시에는 먹지 않았지만 알림을 줄 것으로 예측됨
-	total_abs_diff_sum2에 모든 분할 데이터셋에 대하여 각 데이터 내에서 오차가 발생한 횟수가 몇 번인지 평균을 출력
-	전체 데이터에 대한 평균 차이의 절대값 합계: 275.6

## App 개발 화면
- 초기 로그인 및 세팅
  <img width="419" alt="스크린샷 2023-07-27 오후 5 07 48" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/4da7c1f1-bb79-432f-a1b4-85e3eec99d08">

- 홈 화면 및 수분 섭취 기록
  <img width="419" alt="스크린샷 2023-07-27 오후 5 08 28" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/6687bf2e-e714-4cb5-8b2f-c2158fceaee1">

- 수분 섭취 기록 조회 및 데이터 분석
  <img width="419" alt="스크린샷 2023-07-27 오후 5 09 50" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/b1f4c1e4-1b64-40cf-9256-51585259cc60">

- 유저 정보 수정 및 로그아웃
  <img width="278" alt="스크린샷 2023-07-27 오후 5 10 42" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/f5e5ff0e-234a-4184-8fdd-de764cd67a61">

- 알림 제공
  <img width="142" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/22f918c3-6816-4c21-bf1b-f4f3096961bb">
  <img width="142" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/5695e023-0457-4561-bd5d-09f23b95f9bb">
  <img width="142" alt="image" src="https://github.com/ChoiBoYoung0330/moressang/assets/65601017/be36b7e2-28bc-4731-89f5-e2f018adef73">

# 독창적 핵심기술
[수분섭취량 예측모델]
-	WaterMinder 앱의 경우 가입초기에 등록한 키, 몸무게, 활동량, 기후 등의 정보들을 바탕으로 하루섭취량을 제공. 위의 정보들을 수정하지 않으면 계속 같은 값의 하루섭취량을 목표로 하게되는 fix값
-	유저의 매일 다른 Day Total(ml) 데이터를 기반으로 예측한 현실적으로 가능한 수분섭취량을 매일 제공

[수분섭취시간 예측모델]
-	WaterMinder 앱의 경우 반복적인 시간에 스팸성 알림으로 물을 마실 것을 권장하지만 많은 빈도수로 인해 무시되는 경우가 많음
-	유저의 수분섭취시간의 패턴을 분석하여 반복적인 시간이 아닌 데이터에 기반한 시간에 알림을 제공







- 수분섭취량 기록
- 수분섭취량 조회
- 활동량 기반 수분 섭취 목표 계산
- 섭취기록 기반 예상 섭취량 계산
- 섭취기록 기반 예상 섭취시간 예측
